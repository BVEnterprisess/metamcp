# API Keys Configuration

Configure and manage API keys for programmatic access to MetaMCP.

## Overview

MetaMCP supports API key authentication for:

- Programmatic access to the REST API
- Integration with external systems
- Automated workflows
- CI/CD pipelines
- Third-party applications

## Creating API Keys

### Via Web Interface

1. **Login to MetaMCP**
2. **Navigate to Settings â†’ API Keys**
3. **Click "Create API Key"**
4. **Configure the key**:
   - Name: Descriptive name for the key
   - Permissions: Select required permissions
   - Expiration: Set expiration date (optional)
   - IP Restrictions: Limit to specific IPs (optional)

### Via API

Create API keys programmatically:

```bash
# Create API key via REST API
curl -X POST https://your-domain.com/api/api-keys \
  -H "Authorization: Bearer your-session-token" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "CI/CD Pipeline",
    "permissions": ["mcp-servers:read", "mcp-servers:write"],
    "expiresAt": "2024-12-31T23:59:59Z",
    "ipRestrictions": ["192.168.1.0/24"]
  }'
```

### Programmatic Creation

Using the tRPC client:

```typescript
import { trpc } from "./lib/trpc";

const apiKey = await trpc.apiKeys.create.mutate({
  name: "My Integration",
  permissions: [
    "mcp-servers:read",
    "mcp-servers:write",
    "namespaces:read",
    "tools:execute"
  ],
  expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days
  ipRestrictions: ["10.0.0.0/8"],
});

console.log("API Key:", apiKey.key);
```

## Using API Keys

### HTTP Headers

Include API keys in requests using headers:

```bash
# Method 1: Authorization Bearer header
curl -H "Authorization: Bearer mcp_1234567890abcdef" \
  https://your-domain.com/api/mcp-servers

# Method 2: X-API-Key header
curl -H "X-API-Key: mcp_1234567890abcdef" \
  https://your-domain.com/api/mcp-servers

# Method 3: Query parameter (not recommended for production)
curl "https://your-domain.com/api/mcp-servers?api_key=mcp_1234567890abcdef"
```

### JavaScript/TypeScript

```typescript
// Using fetch
const response = await fetch("https://your-domain.com/api/mcp-servers", {
  headers: {
    "Authorization": "Bearer mcp_1234567890abcdef",
    "Content-Type": "application/json"
  }
});

// Using axios
import axios from "axios";

const api = axios.create({
  baseURL: "https://your-domain.com/api",
  headers: {
    "Authorization": "Bearer mcp_1234567890abcdef"
  }
});

const servers = await api.get("/mcp-servers");
```

### Python

```python
import requests

headers = {
    "Authorization": "Bearer mcp_1234567890abcdef",
    "Content-Type": "application/json"
}

response = requests.get(
    "https://your-domain.com/api/mcp-servers", 
    headers=headers
)

servers = response.json()
```

### cURL Examples

```bash
# Get all MCP servers
curl -H "Authorization: Bearer mcp_1234567890abcdef" \
  https://your-domain.com/api/mcp-servers

# Create a new MCP server
curl -X POST \
  -H "Authorization: Bearer mcp_1234567890abcdef" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "My Server",
    "command": "npx @modelcontextprotocol/server-filesystem /tmp",
    "namespaceId": "namespace-uuid"
  }' \
  https://your-domain.com/api/mcp-servers

# Execute a tool
curl -X POST \
  -H "Authorization: Bearer mcp_1234567890abcdef" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "read_file",
    "arguments": {"path": "/tmp/test.txt"}
  }' \
  https://your-domain.com/api/namespaces/namespace-uuid/tools/execute
```

## Permissions System

### Available Permissions

| Permission | Description |
|------------|-------------|
| `mcp-servers:read` | View MCP servers |
| `mcp-servers:write` | Create/update MCP servers |
| `mcp-servers:delete` | Delete MCP servers |
| `namespaces:read` | View namespaces |
| `namespaces:write` | Create/update namespaces |
| `namespaces:delete` | Delete namespaces |
| `tools:read` | View available tools |
| `tools:execute` | Execute tools |
| `logs:read` | View execution logs |
| `api-keys:read` | View API keys |
| `api-keys:write` | Create/update API keys |
| `api-keys:delete` | Delete API keys |
| `admin:all` | Full administrative access |

### Permission Scoping

Scope permissions to specific resources:

```typescript
const apiKey = await trpc.apiKeys.create.mutate({
  name: "Namespace-Specific Key",
  permissions: [
    "namespaces:read",
    "tools:execute"
  ],
  // Scope to specific namespace
  resourceScopes: {
    namespaces: ["namespace-uuid-1", "namespace-uuid-2"]
  }
});
```

### Custom Permissions

Define custom permission sets:

```typescript
// Permission presets
export const PERMISSION_PRESETS = {
  READ_ONLY: [
    "mcp-servers:read",
    "namespaces:read", 
    "tools:read",
    "logs:read"
  ],
  OPERATOR: [
    "mcp-servers:read",
    "mcp-servers:write",
    "namespaces:read",
    "namespaces:write",
    "tools:execute",
    "logs:read"
  ],
  ADMIN: [
    "admin:all"
  ]
};

// Apply preset
const apiKey = await trpc.apiKeys.create.mutate({
  name: "Operator Key",
  permissions: PERMISSION_PRESETS.OPERATOR
});
```

## Security Features

### IP Restrictions

Limit API key usage to specific IP addresses:

```typescript
const apiKey = await trpc.apiKeys.create.mutate({
  name: "Office Network Only",
  permissions: ["mcp-servers:read"],
  ipRestrictions: [
    "192.168.1.0/24",      // Office network
    "10.0.0.100",          // Specific server
    "203.0.113.0/24"       // VPN range
  ]
});
```

### Rate Limiting

Configure rate limits per API key:

```typescript
const apiKey = await trpc.apiKeys.create.mutate({
  name: "Rate Limited Key", 
  permissions: ["tools:execute"],
  rateLimit: {
    requests: 100,         // 100 requests
    window: 3600,          // per hour
    burst: 10              // burst allowance
  }
});
```

### Expiration

Set automatic expiration:

```typescript
const apiKey = await trpc.apiKeys.create.mutate({
  name: "Temporary Key",
  permissions: ["namespaces:read"],
  expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
});
```

## Management

### Listing API Keys

```bash
# List all API keys
curl -H "Authorization: Bearer your-session-token" \
  https://your-domain.com/api/api-keys

# Filter by name
curl -H "Authorization: Bearer your-session-token" \
  "https://your-domain.com/api/api-keys?name=CI/CD"
```

### Updating API Keys

```bash
# Update permissions
curl -X PUT \
  -H "Authorization: Bearer your-session-token" \
  -H "Content-Type: application/json" \
  -d '{
    "permissions": ["mcp-servers:read", "tools:execute"]
  }' \
  https://your-domain.com/api/api-keys/key-uuid

# Update expiration
curl -X PUT \
  -H "Authorization: Bearer your-session-token" \
  -H "Content-Type: application/json" \
  -d '{
    "expiresAt": "2024-12-31T23:59:59Z"
  }' \
  https://your-domain.com/api/api-keys/key-uuid
```

### Revoking API Keys

```bash
# Revoke specific key
curl -X DELETE \
  -H "Authorization: Bearer your-session-token" \
  https://your-domain.com/api/api-keys/key-uuid

# Revoke all keys for user
curl -X POST \
  -H "Authorization: Bearer your-session-token" \
  https://your-domain.com/api/api-keys/revoke-all
```

### Monitoring Usage

```bash
# Get API key usage statistics
curl -H "Authorization: Bearer your-session-token" \
  https://your-domain.com/api/api-keys/key-uuid/usage

# Get usage for date range
curl -H "Authorization: Bearer your-session-token" \
  "https://your-domain.com/api/api-keys/key-uuid/usage?start=2024-01-01&end=2024-01-31"
```

## Environment Configuration

### Backend Configuration

Configure API key settings in `apps/backend/src/middleware/api-key-auth.middleware.ts`:

```typescript
export const apiKeyConfig = {
  // Key format
  keyPrefix: "mcp_",
  keyLength: 32,
  
  // Security
  hashAlgorithm: "sha256",
  encryptionKey: process.env.API_KEY_ENCRYPTION_KEY,
  
  // Rate limiting
  defaultRateLimit: {
    requests: 1000,
    window: 3600 // 1 hour
  },
  
  // Headers
  headerNames: [
    "Authorization",     // Bearer token
    "X-API-Key",        // Direct key
    "X-API-TOKEN"       // Alternative header
  ],
  
  // Query parameter (disabled by default)
  allowQueryParam: false,
  queryParamName: "api_key"
};
```

### Environment Variables

```env
# API Key encryption (required)
API_KEY_ENCRYPTION_KEY=your-32-character-encryption-key

# Default settings
API_KEY_DEFAULT_EXPIRY=30d
API_KEY_MAX_PERMISSIONS=10
API_KEY_ALLOW_QUERY_PARAM=false

# Rate limiting
API_KEY_DEFAULT_RATE_LIMIT=1000
API_KEY_RATE_LIMIT_WINDOW=3600
```

## Best Practices

### Security

1. **Use strong encryption for storage**
2. **Never log full API keys**
3. **Implement proper rate limiting**
4. **Use IP restrictions when possible**
5. **Set appropriate expiration dates**
6. **Monitor usage regularly**

### Development

```typescript
// Good: Use environment variables
const apiKey = process.env.METAMCP_API_KEY;

// Bad: Hardcode API keys
const apiKey = "mcp_1234567890abcdef";

// Good: Handle errors gracefully
try {
  const response = await api.get("/mcp-servers");
} catch (error) {
  if (error.status === 401) {
    console.error("Invalid API key");
  }
}
```

### Storage

```bash
# Store in environment file
echo "METAMCP_API_KEY=mcp_1234567890abcdef" >> .env

# Use secret management (production)
aws secretsmanager put-secret-value \
  --secret-id metamcp-api-key \
  --secret-string "mcp_1234567890abcdef"
```

## Troubleshooting

### Common Issues

1. **401 Unauthorized**:
   - Check API key format
   - Verify key hasn't expired
   - Ensure proper header format

2. **403 Forbidden**:
   - Check permissions
   - Verify IP restrictions
   - Check resource scoping

3. **429 Too Many Requests**:
   - Check rate limits
   - Implement backoff strategy
   - Consider requesting higher limits

### Debug Mode

Enable API key debugging:

```env
DEBUG=metamcp:api-keys
LOG_LEVEL=debug
```

### Testing

```bash
# Test API key validity
curl -I -H "Authorization: Bearer mcp_1234567890abcdef" \
  https://your-domain.com/api/health

# Check permissions
curl -H "Authorization: Bearer mcp_1234567890abcdef" \
  https://your-domain.com/api/api-keys/permissions
``` 